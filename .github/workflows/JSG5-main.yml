name: John Sandsj√∂ Group 5 - main workflow

on:
  #pipeline starts at push
  #push:
   # branches:
    #  - main

  #pipeline can be started manually
  workflow_dispatch:
    inputs:
      print_test:
        description: 'If true, failed tests will be saved to a log file. If false, no report generated'
        type: boolean
        required: true
        default: false

env:
  OPEN_API_KEY: ${{ secrets.OPEN_API_KEY }}

jobs:
  test_job:
    name: "Job #1 - Tests"
  #----------------------------------------------------------------------------------
  #----------------------------JOB #1 - TEST RUN ------------------------------------
  #----------------------------------------------------------------------------------
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repo code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install pytest and other dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
       
    - name: Run pytest
      id: pytest
      continue-on-error: true
      run: |
        # making sure pytest finds the root and path to weather_app
        export PYTHONPATH=$PYTHONPATH:./ 
        # pytest command finds and execute files starting with 'test_' and save results to a xml file
        pytest --junitxml=reporty.xml

    #- name: Print test result
     # if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.print_test == 'true' && steps.pytest.outcome == 'failure' }}
      #run: |
       # echo "Test failed, generating report"
        # creating folder for reports (idempotent with -p)
        #mkdir -p test_reports_dir 
        # moving the file to the folder
        #if [ -f reporty.xml ]; then
         # mv reporty.xml test_reports_dir/
        #else
         # echo "reporty.xml not found."
        #fi
    
    - name: Upload pytest report as artifact
      #if: ${{ steps.test.outcome == 'failure' && github.event.inputs.print_test == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: pytest-test-report
        path: reporty.xml


  build_and_push_job:
    name: "Job #2 - Build and push docker image to Docker Hub"
    #----------------------------------------------------------------------------------
    #------------------------JOB #2 - Build and Push to Docker Hub --------------------
    #----------------------------------------------------------------------------------
    runs-on: ubuntu-latest
    needs: test_job

    # custom condition so this job runs only if true test success
    if: ${{ needs.test_job.outputs.test_passed == 'success' }}
    
    env:
    #name and path that the final built image in Docker Hub
      DOCKER_IMAGE: johnsandsjo91826/jsg5_weather_app
      DOCKERFILE_PATH: ./dockerfile

    steps:
    - name: Checkout repo code
      uses: actions/checkout@v4
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    

    - name: Build and Push Docker Image
    # This step performs the actual build and push operation.
      uses: docker/build-push-action@v5
      with:
        context: . # Path to where dockerfile is (build context)
        file: ${{ env.DOCKERFILE_PATH }}
        push: true # flag to tell the action to push the image to Docker Hub
        tags: ${{ env.DOCKER_IMAGE }}:latest #hard coded latest tag for simplicity


  #update_web_app:
  #  name: "Job #3 - Update web app in Azure
    #----------------------------------------------------------------------------------
    #------------------------Job #3 - Update web app in Azure -------------------------
    #----------------------------------------------------------------------------------
  #  runs-on: ubuntu-latest
  #  needs: build_and_push_job
    
  #  steps:
  #  - name: azure login
  #    uses: Azure/login@v2.3.0
  #    with:
        #Added this to Github secret recieved from running in the cli `az ad sp create-for-rbac`
   #     creds: ${{ secrets.AZURE_CREDENTIALS }}
   
   # - name: Azure CLI Action
   #   uses: Azure/cli@v2.2.0
   #   with:
   #     inlineScript: |
   #       echo "Refreshing Azure app service automatically"
   #       az webapp config container set \
   #         --name weather-app \
   #         --resource-group rg-devops-course \
   #         --docker-custom-image-name johnsandsjo91826/jsg5_weather_app:latest \
   #         --docker-registry-server-url https://index.docker.io/
  
