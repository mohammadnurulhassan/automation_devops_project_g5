name: John Sandsj√∂ Group 5 - main workflow

#pipeline starts at push
on:
  push:
    branches:
      - main

  #pipeline can be started manually
  workflow_dispatch:
    inputs:
      failed_test:
        description: 'If true, failed tests will be saved to a log file. Otherwise this step is skipped and proceed to build'
        type: boolean
        required: true
        default: true

env:
  OPEhN_API_KEY: ${{ secrets.OPEN_API_KEY }}

jobs:
  test:
    name: "Job #1 - Tests"
  #----------------------------------------------------------------------------------
  #----------------------------JOB #1 - TEST RUN ------------------------------------
  #----------------------------------------------------------------------------------
    runs-on: ubuntu-latest
    
    outputs:
        pytest_outcome: ${{ steps.outcome }}
        
    steps:
    - name: Checkout repo code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install pytest and other dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run pytest
      run: |
        # making sure pytest finds the root and path to weather_app
        export PYTHONPATH=$PYTHONPATH:./ 
        # pytest command finds and execute files starting with 'test_' and save results to a xml file
        pytest --junitxml=reporty.xml

    #- name: Failed test report parameter
      #run: echo "The 'failed_test' parameter is set to '${{ github.event.inputs.failed_test }}'"


  print_test_output:
    name: "Job #2 - printing failed tests"
    #----------------------------------------------------------------------------------
    #----------------------------JOB #2 - Print FAILED TES RUN ------------------------
    #----------------------------------------------------------------------------------
    runs-on: ubuntu-latest
    needs: test
    # check if it was a fialed test run
    if: ${{ github.event.inputs.report_enabled == 'true' && needs.test.result == 'failure' }}
    
    steps:
    - name: Generating failed test report
      run: |
        echo "Test failed, generating report"
        
    - name: Creating folder for reports (idempotent with -p)
      run: mkdir -p failed_reports_dir
        
    - name: Upload Pytest Report as Artifact üìÇ
      uses: actions/upload-artifact@v4
      with:
        name: pytest-test-report # The name you'll see on the GitHub Actions summary page
        path: failed_reports_dir/reporty.xml         # The path to the file you want to upload
    #- name: Upload test report artifact
    #  uses: actions/upload-artifact@v4
    #  with:
    #    name: pytest junit report
     #   path: ${{ env.TEST_LOG_DIR }}/${{ env.TEST_LOG_FILE }} # Path to the file created in the previous step

#vara tydliga namngivningar f√∂r bland annat workflows, jobs och steps.
#2. Anv√§ndning av environment-variabler, GitHub-kontextvariabler och GitHub Secrets (till exempel, API-nycklar och Docker-credentials).
#3. Logik och beroenden (anv√§ndning av needs och if-satser) ska anv√§ndas i pipelinen.
#parameter f√∂r att logga fel:
#  a. Om parametern √§r satt till true och testerna misslyckas, ska en logg-error artefakt genereras.
#  b. Om parametern √§r satt till false, skapas ingen loggfil, oavsett testresultat.
#5. N√§r alla tester √§r godk√§nda ska pipelinen:
#  a. Skapa en Docker-image av applikationen.
#  b. Publicera Docker-imagen p√• DockerHub som √§r kopplad till en Azure-app service (med anv√§ndning av Azure-credentials).
